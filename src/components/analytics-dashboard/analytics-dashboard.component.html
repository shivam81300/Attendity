<div class="p-4 md:p-6 max-w-4xl mx-auto">
    @if (subjects().length > 0 && overallStats().totalClasses > 0) {
        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-slate-200">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button (click)="activeTab.set('overview')"
                        [class]="'px-1 py-3 border-b-2 font-semibold text-sm ' + (activeTab() === 'overview' ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300')">
                    Overview
                </button>
                <button (click)="activeTab.set('trends')"
                        [class]="'px-1 py-3 border-b-2 font-semibold text-sm ' + (activeTab() === 'trends' ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300')">
                    Trends
                </button>
                <button (click)="activeTab.set('calendar')"
                        [class]="'px-1 py-3 border-b-2 font-semibold text-sm ' + (activeTab() === 'calendar' ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300')">
                    Calendar
                </button>
            </nav>
        </div>

        @switch (activeTab()) {
            @case ('overview') {
                <div class="space-y-6">
                    <!-- Overall Stats -->
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-bold text-gray-800">Overall Attendance</h2>
                            <span class="text-xs font-bold bg-indigo-100 text-primary px-2 py-1 rounded-full">LIVE</span>
                        </div>
                        <div class="flex items-end space-x-2 mt-2">
                            <span [class]="'text-5xl font-extrabold ' + (overallStats().percentage >= 75 ? 'text-green-500' : 'text-red-500')">
                                {{ overallStats().percentage.toFixed(1) }}%
                            </span>
                            @if (overallStats().percentage >= 75) {
                                <span class="text-green-500 font-semibold pb-1 flex items-center gap-1">Safe <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></span>
                            }
                        </div>
                        <p class="text-sm text-slate-500 mt-1">Total Classes tracked: {{ overallStats().totalClasses }}</p>
                        <div class="w-full bg-slate-200 rounded-full h-2.5 mt-4">
                        <div [class]="'h-2.5 rounded-full ' + (overallStats().percentage >= 75 ? 'bg-green-500' : 'bg-red-500')" [style.width]="overallStats().percentage + '%'"></div>
                        </div>
                    </div>

                    <!-- Highlights -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        @if(mostAttendedSubject(); as subject) {
                            <div class="bg-white p-4 rounded-xl shadow-sm">
                                <p class="text-sm font-semibold text-green-600">MOST ATTENDED</p>
                                <p class="text-lg font-bold mt-1">{{ subject.name }}</p>
                                <p class="text-3xl font-bold text-green-500">{{ (subject.present / subject.total * 100).toFixed(0) }}%</p>
                                <p class="text-xs text-slate-500 mt-1">Excellent consistency! ✨</p>
                            </div>
                        }
                        @if(highestRiskSubject(); as subject) {
                            <div class="bg-white p-4 rounded-xl shadow-sm">
                                <p class="text-sm font-semibold text-red-600">AT HIGHEST RISK</p>
                                <p class="text-lg font-bold mt-1 truncate">{{ subject.name }}</p>
                                <p class="text-3xl font-bold text-red-500">{{ (subject.present / subject.total * 100).toFixed(0) }}%</p>
                                <p class="text-xs text-slate-500 mt-1">Needs attention! ❗</p>
                            </div>
                        }
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-sm">
                            <h3 class="text-lg font-bold text-gray-800 text-center mb-4">Total Distribution</h3>
                            <div class="h-64 relative">
                                <canvas #overallChart></canvas>
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <div class="text-center">
                                        <p class="text-4xl font-bold">{{ overallStats().totalClasses }}</p>
                                        <p class="text-slate-500 text-sm">Total</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-3 bg-white p-4 rounded-xl shadow-sm">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Subject Comparison</h3>
                            <div class="h-64">
                                <canvas #barChart></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Insights -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Attendance by Day of Week</h3>
                            <div class="h-64">
                                @if (hasDayOfWeekData()) {
                                    <canvas #dayOfWeekChart></canvas>
                                } @else {
                                    <div class="flex items-center justify-center h-full text-slate-400 text-sm">No attendance marked yet.</div>
                                }
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Performance Snapshots</h3>
                            @let timeframes = attendanceForTimeframes();
                            <div class="grid grid-cols-2 gap-4 h-64">
                                <div class="bg-slate-50 rounded-lg p-3 flex flex-col justify-center">
                                    <p class="text-sm text-slate-500 font-semibold">This Week</p>
                                    @if(timeframes.thisWeek.total > 0) {
                                        <p class="text-3xl font-bold" [class]="timeframes.thisWeek.percentage >= 75 ? 'text-green-500' : 'text-red-500'">
                                            {{ timeframes.thisWeek.percentage.toFixed(0) }}<span class="text-lg">%</span>
                                        </p>
                                        @if(timeframes.lastWeek.total > 0) {
                                            @let diff = timeframes.thisWeek.percentage - timeframes.lastWeek.percentage;
                                            <span class="text-xs font-semibold flex items-center" [class]="diff >= 0 ? 'text-green-500' : 'text-red-500'">
                                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                    @if(diff >= 0) {<path d="M10 17a1 1 0 01-1-1V4.414l-3.293 3.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0l5 5a1 1 0 11-1.414 1.414L11 4.414V16a1 1 0 01-1 1z"/>}
                                                    @else {<path d="M10 3a1 1 0 011 1v11.586l3.293-3.293a1 1 0 111.414 1.414l-5 5a1 1 0 01-1.414 0l-5-5a1 1 0 111.414-1.414L9 15.586V4a1 1 0 011-1z"/>}
                                                </svg>
                                                {{ diff.toFixed(0) }}% vs last week
                                            </span>
                                        }
                                    } @else {
                                        <p class="text-3xl font-bold text-slate-400">N/A</p>
                                    }
                                </div>
                                <div class="bg-slate-50 rounded-lg p-3 flex flex-col justify-center">
                                    <p class="text-sm text-slate-500 font-semibold">Last Week</p>
                                    @if(timeframes.lastWeek.total > 0) {
                                        <p class="text-3xl font-bold" [class]="timeframes.lastWeek.percentage >= 75 ? 'text-green-500' : 'text-red-500'">
                                            {{ timeframes.lastWeek.percentage.toFixed(0) }}<span class="text-lg">%</span>
                                        </p>
                                    } @else {
                                        <p class="text-3xl font-bold text-slate-400">N/A</p>
                                    }
                                </div>
                                <div class="bg-slate-50 rounded-lg p-3 flex flex-col justify-center">
                                    <p class="text-sm text-slate-500 font-semibold">This Month</p>
                                     @if(timeframes.thisMonth.total > 0) {
                                        <p class="text-3xl font-bold" [class]="timeframes.thisMonth.percentage >= 75 ? 'text-green-500' : 'text-red-500'">
                                            {{ timeframes.thisMonth.percentage.toFixed(0) }}<span class="text-lg">%</span>
                                        </p>
                                        @if(timeframes.lastMonth.total > 0) {
                                            @let diff = timeframes.thisMonth.percentage - timeframes.lastMonth.percentage;
                                            <span class="text-xs font-semibold flex items-center" [class]="diff >= 0 ? 'text-green-500' : 'text-red-500'">
                                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                    @if(diff >= 0) {<path d="M10 17a1 1 0 01-1-1V4.414l-3.293 3.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0l5 5a1 1 0 11-1.414 1.414L11 4.414V16a1 1 0 01-1 1z"/>}
                                                    @else {<path d="M10 3a1 1 0 011 1v11.586l3.293-3.293a1 1 0 111.414 1.414l-5 5a1 1 0 01-1.414 0l-5-5a1 1 0 111.414-1.414L9 15.586V4a1 1 0 011-1z"/>}
                                                </svg>
                                                {{ diff.toFixed(0) }}% vs last month
                                            </span>
                                        }
                                    } @else {
                                        <p class="text-3xl font-bold text-slate-400">N/A</p>
                                    }
                                </div>
                                <div class="bg-slate-50 rounded-lg p-3 flex flex-col justify-center">
                                    <p class="text-sm text-slate-500 font-semibold">Last Month</p>
                                     @if(timeframes.lastMonth.total > 0) {
                                        <p class="text-3xl font-bold" [class]="timeframes.lastMonth.percentage >= 75 ? 'text-green-500' : 'text-red-500'">
                                            {{ timeframes.lastMonth.percentage.toFixed(0) }}<span class="text-lg">%</span>
                                        </p>
                                    } @else {
                                        <p class="text-3xl font-bold text-slate-400">N/A</p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            }
            @case ('trends') {
                 <div class="bg-white p-4 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-gray-800">Attendance Trends</h2>
                         @if(subjects().length > 0) {
                            <select [value]="selectedSubjectIdForTrend()" (change)="selectedSubjectIdForTrend.set($any($event.target).value)"
                                    class="bg-slate-100 border-slate-200 rounded-md p-2 text-sm font-semibold">
                                <option value="overall">Overall Attendance</option>
                                @for(subject of subjects(); track subject.id) {
                                    <option [value]="subject.id">{{subject.name}}</option>
                                }
                            </select>
                        }
                    </div>
                     @if(selectedSubjectForTrend(); as subject) {
                        <app-trend-chart [subject]="subject"></app-trend-chart>
                    }
                 </div>
            }
            @case ('calendar') {
                <app-calendar-heatmap [subjects]="subjects()"></app-calendar-heatmap>
            }
        }
    } @else {
        <div class="text-center py-20 px-4 bg-white rounded-xl border-2 border-dashed border-slate-300">
            <p class="text-slate-600 text-xl font-bold">No Data to Analyze</p>
            <p class="text-slate-500 mt-2">Add some subjects and mark their attendance to see your progress here.</p>
        </div>
    }
</div>